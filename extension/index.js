var e={current:null};let n,d;!function(e){e.soundCueConfig="soundCueConfig",e.soundCuesEnabled="soundCuesEnabled",e.soundCueList="soundCueList",e.soundCueLog="soundCueLog",e.soundCueTypes="soundCueTypes",e.nodeCGServerSoundCues="soundCues"}(n||(n={})),function(e){e.single="single",e.random="random",e.ordered="ordered"}(d||(d={}));var a=d;function o(d,o){if(!e.current)throw Error("Cue command change failed: NodeCG handle is invalid.");const u=e.current,l=u.Replicant(n.soundCueConfig);if(void 0===l.value&&o&&!o.handled)return void o(Error("Cue command change failed: Sound cue map is undefined."));const i=u.Replicant(n.soundCueList);if(void 0===l.value&&o&&!o.handled)return void o(Error("Cue command change failed: Sound cue list is undefined."));if(!d.commandName&&o&&!o.handled)return void o(Error("Cue command change failed: No cue command name was provided."));if((!d.mappedCues||0===d.mappedCues.length)&&o&&!o.handled)return void o(Error(`Cue command change failed: No cues were mapped to command ${d.commandName}.`));u.log.debug("changing cue command: %s",d.commandName);let r=l.value.findIndex((e=>e.commandName===d.commandName));if(r<0)l.value.push({commandName:d.commandName,coolDownMs:d.coolDownMs,commandType:d.commandType,enabled:d.enabled,orderedMappingIndex:d.commandType===a.ordered?0:null,commandUsageCount:0,lastUseTimestamp:null,allCuesAreValid:d.mappedCues.every((e=>i.value.includes(e))),mappedCues:[...d.mappedCues]});else{let e={...l.value[r],coolDownMs:d.coolDownMs,orderedMappingIndex:d.commandType===a.ordered?0:null,commandType:d.commandType,enabled:d.enabled,allCuesAreValid:d.mappedCues.every((e=>i.value.includes(e))),mappedCues:[...d.mappedCues]};l.value[r]=e}}function u(d,a){if(!e.current)throw Error("Cue command delete failed: NodeCG handle is invalid.");const o=e.current,u=o.Replicant(n.soundCueConfig);if(void 0===u.value&&a&&!a.handled)return void a(Error("Cue command delete failed: Sound cue map is undefined."));if(o.log.debug("deleting cue command: %s",d),!d&&a&&!a.handled)return void a(Error("Cue command delete failed: No cue command name was provided."));let l=u.value.findIndex((e=>e.commandName===d));l<0&&a&&!a.handled?a(Error(`Cue command delete failed: No cue command ${d} was found.`)):u.value=u.value.splice(l,1)}function l({user:n="",message:d=""}){if(!n||!d)return;if(!e.current)throw Error("Cue command change failed: NodeCG handle is invalid.");const a=e.current,o=a.Replicant(SoundAlertReplicants.soundCueConfig);if(void 0===o.value)return void a.log.error("Cue command change failed: Sound cue map is undefined.");const u=d.split(" ")[0];let l=o.value.findIndex((e=>e.commandName===u));if(l<0)return;const i=o.value[l];if(i.enabled||a.log.debug(`Cue command ${u} is disabled, not playing.`),!i.allCuesAreValid)return void a.log.warn(`Cue command ${u} has invalid cues, not playing.`);if(i.coolDownMs&&i.lastUseTimestamp&&Date.now()-i.lastUseTimestamp<i.coolDownMs)return void a.log.warn(`Cue command ${u} is still on cooldown, not playing.`);if(!i.mappedCues||0===i.mappedCues.length)return void a.log.warn(`Cue command ${u} has no mapped cues.`);let r=null,m=i.orderedMappingIndex||0;i.mappedCues.length<m&&(m=0);let s=null;switch(i.commandType){case SoundCommandType.single:r=i.mappedCues[0];break;case SoundCommandType.ordered:r=i.mappedCues[m],s=m+1;break;case SoundCommandType.random:r=i.mappedCues[Math.floor(Math.random()*i.mappedCues.length)];break;default:return void a.log.warn(`Cue command ${u} has an invalid type.`)}const t=a.Replicant(SoundAlertReplicants.soundCueList);void 0!==o.value?r&&t.value.find((e=>e===r))?(a.sendMessage(SoundCommandEvents.playSoundCue,r),o.value[l]={...o.value[l],lastUseTimestamp:Date.now(),orderedMappingIndex:s,commandUsageCount:o.value[l].commandUsageCount+1}):a.log.warn(`Cue command ${u} did not map to a known cue. Mapped cue was ${r||'"null"'}.`):a.log.error("Cue command change failed: Sound cue list is undefined.")}let i;!function(e){e.playedSoundCue="playedCue",e.playSoundCue="playSoundCue",e.upsertSoundCommand="upsertSoundCommand",e.deleteSoundCommand="deleteSoundCommand",e.twitchChatReceived="ChatReceived"}(i||(i={}));var r=i;let m;(m||(m={})).change="change";var s=m;function t(d,a){if(!e.current)throw Error("Cue command delete failed: NodeCG handle is invalid.");const o=e.current,u=o.Replicant(n.soundCueLog,{defaultValue:{}});o.log.info("played cue: %s",d),d&&(d in u.value?u.value[d]+=1:u.value[d]=1,o.log.info("cue %s is now at %s plays",d,u.value[d])),a&&!a.handled&&a(null)}let c;(c||(c={})).twitchListener="twitch-listener",module.exports=function(d){d.log.debug("Soundalerts bundle started."),e.current=d,d.Replicant(n.soundCuesEnabled,{defaultValue:!1}),d.Replicant(n.soundCueLog,{defaultValue:{}});const i=d.Replicant(n.soundCueTypes);i.value||(i.value=[a.ordered,a.random,a.single]);const m=d.Replicant(n.soundCueConfig);m.value=function(){if(!e.current)throw Error("Cue command change failed: NodeCG handle is invalid.");const d=[],o=e.current.readReplicant(n.nodeCGServerSoundCues);if(o&&o.length>0)for(let e=0;e<o.length;e++){let n=o[e];d.push({commandName:n.name.startsWith("!")?n.name:`!${n.name}`,enabled:!1,coolDownMs:null,lastUseTimestamp:null,allCuesAreValid:!0,mappedCues:[n.name],orderedMappingIndex:null,commandType:a.single,commandUsageCount:0})}return d}();const p=d.Replicant(n.soundCueList,{defaultValue:[]});d.Replicant(n.nodeCGServerSoundCues).on(s.change,(e=>{p.value=e.map((e=>e.name))})),p.on(s.change,(e=>{m.value.forEach((n=>{n.allCuesAreValid=n.mappedCues.every((n=>e.includes(n)))}))})),d.listenFor(r.upsertSoundCommand,o),d.listenFor(r.deleteSoundCommand,u),d.listenFor(r.playedSoundCue,t),d.listenFor(r.twitchChatReceived,c.twitchListener,l)};
//# sourceMappingURL=index.js.map
